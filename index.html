<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>TajibMessage Lite</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
:root {
  --bg: #fff; --text: #111; --muted: #666;
  --accent: #3ecf8e; --accent2: #2ebd7b;
  --me: #0a84ff; --them: #f2f5f9;
  --radius: 12px; --shadow: 0 4px 12px rgba(0,0,0,0.08);
}
body {
  margin: 0; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
  background: var(--bg); color: var(--text);
  display: flex; align-items: center; justify-content: center; height: 100vh;
}
.hidden { display: none !important; }
button {
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  color: #fff; border: none; padding: 10px 14px;
  border-radius: var(--radius); font-weight: 600; cursor: pointer;
}
input, textarea {
  width: 100%; padding: 10px; border-radius: var(--radius);
  border: 1px solid #ccc; font-size: 14px;
}
#auth, #app {
  width: 100%; max-width: 400px; padding: 20px;
  box-shadow: var(--shadow); border-radius: var(--radius);
  background: #fff;
}
h2 { margin-top: 0; }
.messages {
  border: 1px solid #ccc; border-radius: var(--radius);
  padding: 10px; height: 300px; overflow-y: auto; margin-bottom: 10px;
}
.msg {
  max-width: 80%; padding: 8px 10px; border-radius: var(--radius);
  margin: 4px 0; word-wrap: break-word;
}
.me-bubble { background: var(--me); color: #fff; margin-left: auto; }
.them-bubble { background: var(--them); }
</style>
</head>
<body>

<!-- Auth Screen -->
<div id="auth">
  <h2>TajibMessage Lite</h2>
  <div id="loginForm">
    <input id="loginEmail" type="email" placeholder="Email" /><br><br>
    <input id="loginPassword" type="password" placeholder="Password" /><br><br>
    <button id="loginBtn">Log In</button>
    <p style="font-size:13px;color:var(--muted)">No account? <a href="#" id="showSignup">Sign up</a></p>
  </div>
  <div id="signupForm" class="hidden">
    <input id="signupEmail" type="email" placeholder="Email" /><br><br>
    <input id="signupPassword" type="password" placeholder="Password" /><br><br>
    <input id="signupCode" type="text" maxlength="10" placeholder="Number ID (10 digits)" /><br><br>
    <button id="signupBtn">Sign Up</button>
    <p style="font-size:13px;color:var(--muted)">Have an account? <a href="#" id="showLogin">Log in</a></p>
  </div>
</div>

<!-- App Screen -->
<div id="app" class="hidden">
  <h2>Messages</h2>
  <div class="messages" id="messages"></div>
  <div id="newMessageForm" class="hidden">
    <input id="friendId" type="text" maxlength="10" placeholder="Friend's Number ID" /><br><br>
    <textarea id="messageText" placeholder="Type your message..."></textarea><br><br>
    <button id="sendBtn">Send</button>
  </div>
  <button id="newMsgBtn">+ New Message</button>
  <button id="logoutBtn" style="background:#ccc;color:#000;margin-top:10px">Logout</button>
</div>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
/* ===== Supabase Config ===== */
const SUPABASE_URL = "https://rqiwzsenaaejtczzwsfk.supabase.co"; // replace
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJxaXd6c2VuYWFlanRjenp3c2ZrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MDk0NDYsImV4cCI6MjA3MjM4NTQ0Nn0.UdDK7oOMZhZOQuKp8lD5VbNhSpYDr7LpLoq7J4MlvW4"; // replace
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ===== State ===== */
let me = null; // my user row
let friend = null; // friend user row
let channel = null;

/* ===== Helpers ===== */
const $ = (sel) => document.querySelector(sel);
function toast(msg){ alert(msg); } // simple alert for now
function esc(s=""){ return String(s).replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m])); }

/* ===== Auth UI Switch ===== */
$("#showSignup").onclick = () => {
  $("#loginForm").classList.add("hidden");
  $("#signupForm").classList.remove("hidden");
};
$("#showLogin").onclick = () => {
  $("#signupForm").classList.add("hidden");
  $("#loginForm").classList.remove("hidden");
};

/* ===== Auth State ===== */
sb.auth.onAuthStateChange(async (_evt, session) => {
  if (session?.user) {
    await ensureUserRow(session.user);
    await loadMe();
    $("#auth").classList.add("hidden");
    $("#app").classList.remove("hidden");
  } else {
    $("#auth").classList.remove("hidden");
    $("#app").classList.add("hidden");
  }
});

/* ===== Ensure user row exists ===== */
async function ensureUserRow(authUser){
  const { data: row } = await sb.from("users").select("*").eq("auth_id", authUser.id).maybeSingle();
  if (!row) {
    const code = String(Math.floor(1000000000 + Math.random()*9000000000));
    await sb.from("users").insert({
      auth_id: authUser.id,
      unique_id: code,
      email: authUser.email,
      display_name: authUser.email.split("@")[0]
    });
  }
}

/* ===== Load my profile ===== */
async function loadMe(){
  const { data } = await sb.from("users").select("*").eq("auth_id", (await sb.auth.getUser()).data.user.id).single();
  me = data;
}

/* ===== Login ===== */
$("#loginBtn").onclick = async () => {
  const email = $("#loginEmail").value.trim();
  const pwd = $("#loginPassword").value;
  const { error } = await sb.auth.signInWithPassword({ email, password: pwd });
  if (error) toast("Login failed");
};

/* ===== Signup ===== */
$("#signupBtn").onclick = async () => {
  const email = $("#signupEmail").value.trim();
  const pwd = $("#signupPassword").value;
  const code = $("#signupCode").value.trim();
  if (code.length !== 10) return toast("Number ID must be 10 digits");
  const { data, error } = await sb.auth.signUp({ email, password: pwd });
  if (error) return toast("Check your inbox to confirm");
  const user = data.user;
  await sb.from("users").insert({
    auth_id: user.id,
    unique_id: code,
    email,
    display_name: email.split("@")[0]
  });
};

/* ===== Logout ===== */
$("#logoutBtn").onclick = async () => { await sb.auth.signOut(); };
</script>
<script>
/* ===== Toggle New Message Form ===== */
$("#newMsgBtn").onclick = () => {
  $("#newMessageForm").classList.toggle("hidden");
};

/* ===== Send Message ===== */
$("#sendBtn").onclick = async () => {
  const fid = $("#friendId").value.trim();
  const text = $("#messageText").value.trim();
  if (!fid || !text) return toast("Enter friend ID and message");

  // Find friend by number ID
  const { data: f } = await sb.from("users").select("*").eq("unique_id", fid).maybeSingle();
  if (!f) return toast("No user with that ID");

  friend = f;

  // Insert message
  const { error } = await sb.from("messages").insert({
    sender_id: me.id,
    receiver_id: friend.id,
    content: text
  });
  if (error) return toast("Failed to send");

  $("#messageText").value = "";
};

/* ===== Load Messages ===== */
async function loadMessages(){
  if (!friend) return;
  const { data: msgs } = await sb
    .from("messages")
    .select("*")
    .or(
      `and(sender_id.eq.${me.id},receiver_id.eq.${friend.id}),
       and(sender_id.eq.${friend.id},receiver_id.eq.${me.id})`
    )
    .order("created_at", { ascending: true });

  const box = $("#messages");
  box.innerHTML = "";
  (msgs || []).forEach(m => {
    const mine = m.sender_id === me.id;
    const div = document.createElement("div");
    div.className = `msg ${mine ? "me-bubble" : "them-bubble"}`;
    div.textContent = m.content;
    box.appendChild(div);
  });
  box.scrollTop = box.scrollHeight;
}

/* ===== Realtime Subscription ===== */
function bindRealtime(){
  if (channel) sb.removeChannel(channel);
  if (!friend) return;

  channel = sb.channel("chat")
    .on("postgres_changes", {
      event: "INSERT",
      schema: "public",
      table: "messages",
      filter: `or(
        and(sender_id.eq.${me.id},receiver_id.eq.${friend.id}),
        and(sender_id.eq.${friend.id},receiver_id.eq.${me.id})
      )`
    }, payload => {
      const m = payload.new;
      const mine = m.sender_id === me.id;
      const div = document.createElement("div");
      div.className = `msg ${mine ? "me-bubble" : "them-bubble"}`;
      div.textContent = m.content;
      $("#messages").appendChild(div);
      $("#messages").scrollTop = $("#messages").scrollHeight;
    }).subscribe();
}

/* ===== Auto-load messages when friend ID entered ===== */
$("#friendId").addEventListener("change", async () => {
  const fid = $("#friendId").value.trim();
  if (fid.length === 10) {
    const { data: f } = await sb.from("users").select("*").eq("unique_id", fid).maybeSingle();
    if (f) {
      friend = f;
      await loadMessages();
      bindRealtime();
    }
  }
});
</script>
