<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Tajib Lite ‚Äî Firebase with Notifications</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
* { box-sizing: border-box; }
body {
  margin: 0; 
  font-family: 'Inter', sans-serif; 
  background: #f5f6fa;
  height: 100vh; 
  display: flex; 
  flex-direction: column;
}
.hidden { display: none !important; }

/* Auth Screen - Modernized */
#auth {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  height: 100vh;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  padding: 20px;
}

.auth-container {
  background: white;
  border-radius: 16px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
  width: 100%;
  max-width: 400px;
  padding: 30px;
  text-align: center;
}

.auth-header {
  margin-bottom: 25px;
}

.auth-header h2 {
  margin: 0 0 8px 0;
  font-size: 24px;
  font-weight: 700;
  color: #333;
}

.auth-header p {
  margin: 0;
  color: #666;
  font-size: 14px;
}

.auth-form input {
  width: 100%;
  padding: 14px 16px;
  margin-bottom: 16px;
  border: 1px solid #ddd;
  border-radius: 12px;
  font-size: 15px;
  font-family: 'Inter', sans-serif;
  transition: all 0.2s ease;
  outline: none;
}

.auth-form input:focus {
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.auth-form button {
  width: 100%;
  padding: 14px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  margin-top: 8px;
}

.auth-form button:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
}

.auth-toggle {
  margin-top: 20px;
  font-size: 14px;
  color: #666;
}

.auth-toggle a {
  color: #667eea;
  text-decoration: none;
  font-weight: 500;
  cursor: pointer;
}

/* Layout */
#app {
  flex: 1; display: flex; height: 100%;
}
.sidebar {
  width: 280px; background: #fff; border-right: 1px solid #ddd;
  display: flex; flex-direction: column;
}
.sidebar-header {
  padding: 15px; display: flex; justify-content: space-between; align-items: center;
  border-bottom: 1px solid #ddd;
}
.sidebar-header h2 { margin: 0; font-size: 18px; }
.contacts {
  flex: 1; overflow-y: auto;
}
.contact {
  display: flex; align-items: center; padding: 10px; cursor: pointer;
  border-bottom: 1px solid #f0f0f0; position: relative;
}
.contact:hover { background: #f9f9f9; }
.contact img {
  width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; object-fit: cover;
}
.contact-info { flex: 1; }
.contact-info .name { font-weight: bold; }
.contact-info .id { font-size: 12px; color: #666; }
.badge {
  background: #ff4757; color: #fff; font-size: 11px; padding: 2px 6px;
  border-radius: 10px; position: absolute; right: 10px; top: 50%;
  transform: translateY(-50%);
}

/* Chat area */
.chat {
  flex: 1; display: flex; flex-direction: column;
}
.chat-header {
  padding: 15px; border-bottom: 1px solid #ddd; display: flex; align-items: center;
}
.chat-header img {
  width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; object-fit: cover;
}
.chat-messages {
  flex: 1; padding: 15px; overflow-y: auto; background: #fafafa;
}
.msg {
  max-width: 70%; padding: 12px 16px; border-radius: 18px; margin: 6px 0;
  word-wrap: break-word; font-size: 15px;
}
.me { background: #0a84ff; color: #fff; margin-left: auto; border-bottom-right-radius: 4px; }
.them { background: #e0e0e0; border-bottom-left-radius: 4px; }

/* Input bar */
.chat-input {
  display: flex; align-items: center; padding: 10px; border-top: 1px solid #ddd;
  background: #fff;
}
.chat-input input[type="text"] {
  flex: 1; padding: 12px 16px; border-radius: 20px; border: 1px solid #ccc;
  font-size: 14px; outline: none; font-family: 'Inter', sans-serif;
}
.chat-input button {
  background: none; border: none; margin-left: 8px; cursor: pointer;
  font-size: 20px; padding: 8px; border-radius: 50%;
  transition: background-color 0.2s;
}
.chat-input button:hover { background-color: #f0f0f0; color: #0a84ff; }

/* Toast */
.toast {
  position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(20px);
  background: rgba(0,0,0,0.85); color: #fff; padding: 12px 20px;
  border-radius: 12px; opacity: 0; pointer-events: none;
  transition: opacity 0.3s, transform 0.3s; z-index: 999; font-size: 14px;
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
</style>
</head>
<body>

<!-- Auth Screen - Modernized -->
<div id="auth">
  <div class="auth-container">
    <div class="auth-header">
      <h2>Tajib Lite</h2>
      <p>Sign in to continue messaging</p>
    </div>
    
    <div id="loginForm">
      <div class="auth-form">
        <input id="loginEmail" type="email" placeholder="Email" />
        <input id="loginPassword" type="password" placeholder="Password" />
        <button id="loginBtn">Log In</button>
      </div>
      <div class="auth-toggle">
        <p>No account? <a href="#" id="showSignup">Sign up</a></p>
      </div>
    </div>
    
    <div id="signupForm" class="hidden">
      <div class="auth-form">
        <input id="signupEmail" type="email" placeholder="Email" />
        <input id="signupPassword" type="password" placeholder="Password" />
        <input id="signupCode" type="text" maxlength="10" placeholder="Number ID (10 digits)" />
        <button id="signupBtn">Sign Up</button>
      </div>
      <div class="auth-toggle">
        <p>Have an account? <a href="#" id="showLogin">Log in</a></p>
      </div>
    </div>
  </div>
</div>

<!-- App Screen -->
<div id="app" class="hidden">
  <div class="sidebar">
    <div class="sidebar-header">
      <h2>Contacts</h2>
      <button id="addContactBtn">+</button>
    </div>
    <div class="contacts" id="contactsList"></div>
  </div>
  <div class="chat">
    <div class="chat-header" id="chatHeader">
      <img id="chatAvatar" src="" alt="" />
      <div>
        <div id="chatName"></div>
        <div id="chatNumberId" style="font-size:12px;color:#666;"></div>
      </div>
    </div>
    <div class="chat-messages" id="messages"></div>
    <div class="chat-input">
      <input id="messageText" type="text" placeholder="Type a message..." />
      <button id="sendBtn">üì®</button>
      <button id="voiceBtn">üé§</button>
      <button id="imageBtn">üñºÔ∏è</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="toast"></div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, addDoc, collection, query, where, orderBy, onSnapshot, serverTimestamp, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

/* ===== Firebase Config ===== */
const firebaseConfig = {
  apiKey: "AIzaSyBQebZVAnxwEySzQZf3S4EpTW1YCFUTiHs",
  authDomain: "tajibmessage.firebaseapp.com",
  projectId: "tajibmessage",
  storageBucket: "tajibmessage.firebasestorage.app",
  messagingSenderId: "74585771811",
  appId: "1:74585771811:web:c5d196f4ffd6acb8de4696",
  measurementId: "G-QQJT29P8PS"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ===== State ===== */
let me = null;
let currentChat = null;
let unsubMessages = null;
let unsubNotifications = null;

/* ===== Helpers ===== */
const $ = sel => document.querySelector(sel);
function toast(msg) {
  const t = $("#toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(() => t.classList.remove("show"), 2000);
}

/* ===== Auth UI Switch ===== */
$("#showSignup").onclick = (e) => { 
  e.preventDefault();
  $("#loginForm").classList.add("hidden"); 
  $("#signupForm").classList.remove("hidden"); 
};
$("#showLogin").onclick = (e) => { 
  e.preventDefault();
  $("#signupForm").classList.add("hidden"); 
  $("#loginForm").classList.remove("hidden"); 
};

/* ===== Auth State ===== */
onAuthStateChanged(auth, async user => {
  if (user) {
    const snap = await getDoc(doc(db, "users", user.uid));
    me = snap.exists() ? snap.data() : null;
    $("#auth").classList.add("hidden");
    $("#app").classList.remove("hidden");
    loadContacts();
    listenForNotifications();
  } else {
    $("#auth").classList.remove("hidden");
    $("#app").classList.add("hidden");
    me = null;
    if (unsubMessages) unsubMessages();
    if (unsubNotifications) unsubNotifications();
  }
});

/* ===== Signup ===== */
$("#signupBtn").onclick = async () => {
  const email = $("#signupEmail").value.trim();
  const pwd = $("#signupPassword").value;
  const code = $("#signupCode").value.trim();
  if (!email || !pwd || !code) return toast("Fill all fields");
  if (code.length !== 10) return toast("Number ID must be 10 digits");
  try {
    const cred = await createUserWithEmailAndPassword(auth, email, pwd);
    await setDoc(doc(db, "users", cred.user.uid), {
      uid: cred.user.uid,
      email,
      numberId: code,
      name: email.split("@")[0],
      avatar: ""
    });
    toast("Account created");
  } catch (e) {
    toast(e.message);
  }
};

/* ===== Login ===== */
$("#loginBtn").onclick = async () => {
  const email = $("#loginEmail").value.trim();
  const pwd = $("#loginPassword").value;
  if (!email || !pwd) return toast("Enter email and password");
  try {
    await signInWithEmailAndPassword(auth, email, pwd);
    toast("Logged in");
  } catch (e) {
    toast(e.message);
  }
};

/* ===== Logout ===== */
// Adding a logout button to the sidebar header
const sidebarHeader = document.querySelector('.sidebar-header');
const logoutBtn = document.createElement('button');
logoutBtn.textContent = 'Logout';
logoutBtn.id = 'logoutBtn';
logoutBtn.style.background = 'none';
logoutBtn.style.border = 'none';
logoutBtn.style.cursor = 'pointer';
logoutBtn.style.fontSize = '14px';
logoutBtn.style.color = '#666';
sidebarHeader.appendChild(logoutBtn);

$("#logoutBtn").onclick = async () => { 
  await signOut(auth); 
  toast("Logged out"); 
};

/* ===== Load Contacts ===== */
async function loadContacts() {
  const q = query(collection(db, "users"));
  const snap = await getDocs(q);
  const list = $("#contactsList");
  list.innerHTML = "";
  snap.forEach(docSnap => {
    const u = docSnap.data();
    if (u.uid !== me.uid) {
      const div = document.createElement("div");
      div.className = "contact";
      div.innerHTML = `
        <img src="${u.avatar || 'https://via.placeholder.com/40'}" />
        <div class="contact-info">
          <div class="name">${u.name || u.email}</div>
          <div class="id">${u.numberId}</div>
        </div>
      `;
      div.onclick = () => openChat(u);
      list.appendChild(div);
    }
  });
}

/* ===== Open Chat ===== */
function openChat(user) {
  currentChat = user;
  $("#chatAvatar").src = user.avatar || "https://via.placeholder.com/40";
  $("#chatName").textContent = user.name || user.email;
  $("#chatNumberId").textContent = user.numberId;
  loadMessages();
  clearBadge(user.uid);
}

/* ===== Send Message ===== */
$("#sendBtn").onclick = async () => {
  if (!currentChat) return toast("Select a contact first");
  const text = $("#messageText").value.trim();
  if (!text) return;
  await addDoc(collection(db, "messages"), {
    senderId: me.uid,
    senderName: me.name || me.email,
    receiverId: currentChat.uid,
    receiverNumberId: currentChat.numberId,
    text,
    createdAt: serverTimestamp(),
    unread: true
  });
  $("#messageText").value = "";
};

// Add event listener for Enter key in message input
$("#messageText").addEventListener("keypress", (e) => {
  if (e.key === "Enter") {
    $("#sendBtn").click();
  }
});

/* ===== Load Messages ===== */
function loadMessages() {
  if (unsubMessages) unsubMessages();
  const q = query(
    collection(db, "messages"),
    where("senderId", "in", [me.uid, currentChat.uid]),
    where("receiverId", "in", [me.uid, currentChat.uid]),
    orderBy("createdAt")
  );
  unsubMessages = onSnapshot(q, snap => {
    const box = $("#messages");
    box.innerHTML = "";
    snap.forEach(docSnap => {
      const m = docSnap.data();
      const mine = m.senderId === me.uid;
      const div = document.createElement("div");
      div.className = `msg ${mine ? "me" : "them"}`;
      div.textContent = m.text;
      box.appendChild(div);
    });
    box.scrollTop = box.scrollHeight;
  });
}

/* ===== Notifications ===== */
function listenForNotifications() {
  const q = query(
    collection(db, "messages"),
    where("receiverId", "==", me.uid),
    where("unread", "==", true)
  );
  unsubNotifications = onSnapshot(q, snap => {
    snap.docChanges().forEach(change => {
      if (change.type === "added") {
        const m = change.doc.data();
        toast(`${m.senderName} messaged you`);
        showBadge(m.senderId);
      }
    });
  });
}

function showBadge(uid) {
  const contacts = document.querySelectorAll(".contact");
  contacts.forEach(c => {
    const idText = c.querySelector(".id").textContent;
    if (currentChat && currentChat.uid === uid) return; // already open
    if (!c.querySelector(".badge")) {
      const badge = document.createElement("div");
      badge.className = "badge";
      badge.textContent = "1";
      c.appendChild(badge);
    }
  });
}

function clearBadge(uid) {
  const contacts = document.querySelectorAll(".contact");
  contacts.forEach(c => {
    const badge = c.querySelector(".badge");
    if (badge) badge.remove();
  });
  // Mark messages as read
  const q = query(
    collection(db, "messages"),
    where("senderId", "==", uid),
    where("receiverId", "==", me.uid),
    where("unread", "==", true)
  );
  getDocs(q).then(snap => {
    snap.forEach(docSnap => {
      updateDoc(doc(db, "messages", docSnap.id), { unread: false });
    });
  });
}
</script>
<!-- End of Firebase Logic -->
</body>
</html>
